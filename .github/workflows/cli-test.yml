name: CLI E2E Test
on: [push]

jobs:
  cli-e2e-test:
    name: CLI E2E Test
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - name: Checkout 📥
        uses: actions/checkout@v2.3.4
        with:
          fetch-depth: 0
      - name: Setup Node 💿
        uses: actions/setup-node@v2.1.4
        with:
          node-version: 14
      - name: Install global dependencies 🐱‍
        run: npm install -g verdaccio lerna npm-cli-adduser
      - name: Install development dependencies 📚
        run: npm ci

      - name: Run verdaccio
        run: |
          verdaccio &
          VERDACCIO_PID=$!
          echo "VERDACCIO_PID=$!" >> $GITHUB_ENV
          npm config set registry http://localhost:4873
      - name: Replace package versions
        run: npm run meta:replace-versions -- 999.999.999
      - name: Login and publish to verdaccio
        run: |
          npm-cli-adduser -u thebox -p where -e thebox@nothere.com -r http://localhost:4873
          npm whoami
          lerna exec 'npm publish --registry="http://localhost:4873"'
        env:
          NPM_USER: thebox
          NPM_PASS: 'where-is-the-box?'
          NPM_EMAIL: 'thebox@not-here.dot.com.lol'
          NPM_REGISTRY: 'http://localhost:4873/'
      - name: WhoAmI
        run: npm whoami
      - name: Publish
        run: lerna exec 'npm publish --registry="http://localhost:4873"'
      - name: Install CLI from verdaccio
        run: npm install -g @wuespace/telestion-client-cli
      - name: Initialize PSC Project
        working-directory: '~'
        run: tc-cli init psc
      - name: Run tc-cli commands
        working-directory: '~/psc'
        run: |
          tc-cli generate widget test-widget
          tc-cli stats
          tc-cli build

      - name: Stop verdaccio 🛑
        run: kill -SIGHUP "$VERDACCIO_PID"
