name: Test
on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  cli-e2e-test:
    name: E2E CLI on Node v${{ matrix.node }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: ['14', '16']
    steps:
      - name: Checkout ðŸ“¥
        uses: actions/checkout@v3.0.0
      - name: Setup PNPM ðŸ’¿
        uses: pnpm/action-setup@v2.2.1
        with:
          version: 7.0.0-rc.2
      - name: Setup Node ðŸ’¿
        uses: actions/setup-node@v3.0.0
        with:
          node-version: ${{ matrix.node }}
          cache: 'pnpm'
      - name: Setup git âš™
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      - name: Install dependencies ðŸ“š
        run: pnpm install

      - name: Run verdaccio ðŸ’¡
        run: |
          pnpm dlx verdaccio &
          pnpm config set registry http://localhost:4873

      - name: Login to verdaccio ðŸ›‚
        run: pnpm dlx npm-cli-adduser -u thebox -p where -e thebox@nothere.com -r http://localhost:4873
      - name: Npm get logged in user
        run: pnpm whoami
      - name: Publish to verdaccio ðŸ“¤
        run: pnpm publish --force

      - name: Install CLI from verdaccio ðŸª¤
        run: pnpm add --global @wuespace/telestion-client-cli
      - name: Show help output of CLI
        run: tc-cli --help
      - name: Initialize PSC Project ðŸ›’
        working-directory: '../../'
        run: tc-cli init psc

      - name: Generate a new widget in the PSC ðŸ› 
        working-directory: '../../psc'
        run: |
          tc-cli generate --help
          tc-cli generate widget test-widget
      - name: Show stats of the PSC ðŸ–¨
        working-directory: '../../psc'
        run: |
          tc-cli stats --help
          tc-cli stats
      - name: Build the PSC ðŸ“¦
        working-directory: '../../psc'
        run: |
          tc-cli build --help
          tc-cli build
