name: Test and Coverage

# Events that trigger this workflow
on: [push, pull_request]

jobs:
  jest-unit-tests:
    name: Running unit tests using Jest
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ðŸ“¥
        uses: actions/checkout@v2.3.4
      - name: Setup Node ðŸ’¿
        uses: actions/setup-node@v2.1.5
        with:
          node-version: 14

      - name: Restore npm cache â™»ï¸
        uses: actions/cache@v2.1.4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # Remove, when setup-node action supports specifying the node version
      - name: Install npm v7 â¬†
        run: npm install --global npm@v7

      - name: Install development dependencies ðŸ“š
        run: npm ci

      - name: Build all packages ðŸ› ï¸
        run: npm run build:all
      - name: Run unit tests and generate coverage ðŸ›ƒ
        run: npm run test

  cli-e2e-test:
    name: CLI E2E Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ðŸ“¥
        uses: actions/checkout@v2.3.4
      - name: Setup Node ðŸ’¿
        uses: actions/setup-node@v2.1.5
        with:
          node-version: 14
      - name: Setup git âš™
        run: |
          git config --global user.name "${GITHUB_ACTOR}"
          git config --global user.email "${GITHUB_ACTOR}@users.noreply.github.com"

      - name: Restore npm cache â™»ï¸
        uses: actions/cache@v2.1.4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # Remove, when setup-node action supports specifying the node version
      - name: Install npm v7 â¬†
        run: npm install --global npm@v7

      - name: Install global dependencies ðŸ±â€
        run: npm install -g verdaccio lerna npm-cli-adduser
      - name: Install development dependencies ðŸ“š
        run: npm ci

      - name: Add node_modules binaries to path â›“
        run: echo "${GITHUB_WORKSPACE}/node_modules/.bin" >> $GITHUB_PATH

      - name: Run verdaccio ðŸ’¡
        run: |
          verdaccio &
          VERDACCIO_PID=$!
          echo "VERDACCIO_PID=$!" >> $GITHUB_ENV
          npm config set registry http://localhost:4873

      - name: Replace package versions ðŸ–‹
        run: npm run meta:replace-versions -- 999.999.999
      - name: Login to verdaccio ðŸ›‚
        run: |
          npm-cli-adduser -u thebox -p where -e thebox@nothere.com -r http://localhost:4873
      - name: Npm get logged in user
        run: npm whoami
      - name: Publish to verdaccio ðŸ“¤
        run: lerna exec 'npm publish --registry="http://localhost:4873"'

      - name: Install CLI from verdaccio ðŸª¤
        run: npm install -g @wuespace/telestion-client-cli
      - name: Show help output of CLI
        run: tc-cli --help
      - name: Initialize PSC Project ðŸ›’
        working-directory: '../../'
        run: tc-cli init psc

      - name: Generate a new widget in the PSC ðŸ› 
        working-directory: '../../psc'
        run: |
          tc-cli generate --help
          tc-cli generate widget test-widget
      - name: Show stats of the PSC ðŸ–¨
        working-directory: '../../psc'
        run: |
          tc-cli stats --help
          tc-cli stats
      - name: Build the PSC ðŸ“¦
        working-directory: '../../psc'
        run: |
          tc-cli build --help
          tc-cli build

      - name: Stop verdaccio ðŸ›‘
        run: kill -SIGHUP "$VERDACCIO_PID"
